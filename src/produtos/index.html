<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Gerenciamento de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="navbar"></div>

    <!-- #region Main App -->

    <div class="container-xxl mt-5">
        <h1 class="mb-4">Lista de Produtos</h1>

        <div class="row mb-3">
            <div class="col-md-6">
                <form id="searchForm" class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome">
                    <button id="searchButton" class="btn btn-primary" type="submit">Buscar</button>
                </form>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success btn-add-product" data-bs-toggle="modal" data-bs-target="#modalProduct"
                    id="addProductButton">
                    Adicionar Produto
                </button>
            </div>
        </div>

        <div class="table-responsive" id="productsContainer">
            <div id="loadingSpinner" class="text-center my-3" style="display:none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>

        </div>
    </div>

    <!-- #endregion Main App -->

    <!-- #region Product Modal -->

    <div class="modal fade" id="modalProduct" tabindex="-1" aria-labelledby="modalProductLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalProductLabel">Cadastro de Produto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formProduct" novalidate>
                        <input type="hidden" id="productId" value="">

                        <div class="mb-3">
                            <label for="productName" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="productName"
                                placeholder="Digite o nome do produto" required maxlength="100">
                            <div class="invalid-feedback">O nome é obrigatório e deve ter no máximo 100 caracteres.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Descrição</label>
                            <textarea class="form-control" id="productDescription"
                                placeholder="Digite a descrição do produto" rows="3" required
                                maxlength="255"></textarea>
                            <div class="invalid-feedback">A descrição é obrigatória e deve ter no máximo 255 caracteres.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="productPrice" class="form-label">Preço</label>
                            <input type="text" class="form-control" id="productPrice" placeholder="0,00" required>
                            <div class="invalid-feedback">
                                O preço é obrigatório, deve ser um número positivo e não pode ser maior que
                                R$1.000.000,00.
                            </div>

                        </div>

                        <div class="mb-3">
                            <label for="productStockQuantity" class="form-label">Quantidade em Estoque</label>
                            <input type="number" class="form-control" id="productStockQuantity" placeholder="0" min="0"
                                max="10000" required>
                            <div class="invalid-feedback">A quantidade em estoque é obrigatória, deve ser um número
                                positivo e nao pode ser maior que 10000.</div>

                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger  me-2"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">Confirmar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- #endregion -->

    <!-- #region Delete Product Modal -->

    <div class="modal fade" id="modalDeleteProduct" tabindex="-1" aria-labelledby="modalDeleteProductLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalDeleteProductLabel">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteProductMessage"></p>
                    <input type="hidden" id="deleteProductId" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteProduct">Deletar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- #endregion -->

    <!-- #region Scripts -->

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/components/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../js/services/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="../js/components/toast.js"></script>

    <script>

        //#region Fetch Products

        function fetchProducts(event) {

            if (event && typeof event.preventDefault === 'function')
                event.preventDefault();

            const $container = $('#productsContainer');

            const searchValue = $('#searchInput').val();
            const spinner = $('#loadingSpinner');

            $container.find('table').addClass('opacity-50');
            spinner.show();

            api.get(`/products?name=${searchValue}`)
                .then(response => {
                    spinner.hide();
                    $container.html(response.data);

                    $container.find('.btn-update').each(function () {
                        $(this).on('click', function () {
                            const productId = $(this).closest('tr').find('td').first().text().trim();
                            openUpdateProductModal(productId);
                        });
                    });

                    $container.find('.btn-delete').each(function () {
                        $(this).on('click', function () {
                            const productId = $(this).data('id');
                            const nameProduct = $(this).data('name');
                            openDeleteProductModal(productId, nameProduct);
                        });
                    });
                })
                .catch(handleApiError);
        }

        //#endregion

        //#region Open Modals

        function openUpdateProductModal(idProduct) {
            api.get(`/product/${idProduct}`)
                .then(response => {
                    const product = response.data;
                    $('#productId').val(product.id);
                    $('#productName').val(product.name);
                    $('#productDescription').val(product.description);
                    $('#productPrice').val(product.price);
                    $('#productStockQuantity').val(product.stockQuantity);

                    const modal = bootstrap.Modal.getOrCreateInstance($('#modalProduct')[0]);
                    $('#modalProductLabel').text("Atualizar Produto");
                    modal.show();
                })
                .catch(handleApiError);
        }

        function openDeleteProductModal(idProduct, nameProduct) {
            $('#deleteProductId').val(idProduct);
            $('#deleteProductMessage').text(`Deseja realmente excluir o produto "${nameProduct}"?`);
            const modal = new bootstrap.Modal($('#modalDeleteProduct')[0]);
            modal.show();
        }

        function openProductModalInsert() {
            const modal = bootstrap.Modal.getOrCreateInstance($('#modalProduct')[0]);
            $('#formProduct')[0].reset();
            $('#modalProductLabel').text("Adicionar Novo Produto");
            $('#productId').val("");
            modal.show();
        }

        //#endregion

        //#region Delete Product

        $("#confirmDeleteProduct").on("click", function () {
            const productId = $("#deleteProductId").val();

            api.delete(`/product/${productId}`)
                .then(response => {
                    showToast(response.data.message || "Produto deletado com sucesso!", "success");
                    bootstrap.Modal.getInstance($('#modalDeleteProduct')[0]).hide();
                    $('#searchButton').click();
                })
                .catch(error => {
                    console.error("Erro ao deletar produto:", error);
                    handleApiError(error);

                });
        });

        //#endregion

        //#region Submit Product Form

        $("#formProduct").on("submit", function (e) {
            e.preventDefault();

            const form = this;

            if (!form.checkValidity()) {
                e.stopPropagation();
                $(form).addClass("was-validated");
                return;
            }

            let raw = $('#productPrice').cleanVal();
            let price = parseFloat(raw) / 100;

            const product = {
                name: $("#productName").val().trim(),
                description: $("#productDescription").val().trim(),
                price: price,
                stockQuantity: parseInt($("#productStockQuantity").val())
            };

            const productId = $("#productId").val();

            if (productId) {

                api.put(`/product/${productId}`, product)
                    .then(response => {
                        showToast(response.data.message || "Produto atualizado com sucesso!", "success");
                        bootstrap.Modal.getInstance($('#modalProduct')[0]).hide();
                        $('#searchButton').click();
                    })
                    .catch(error => {
                        handleApiError(error);
                    });
            } else {

                api.post("/product", product)
                    .then(response => {
                        showToast(response.data.message || "Produto cadastrado com sucesso!", "success");
                        bootstrap.Modal.getInstance($('#modalProduct')[0]).hide();
                        $('#searchButton').click();
                    })
                    .catch(handleApiError);

            }
        });

        //#endregion

        //#region Reset Modal Form

        $('#modalProduct').on('hidden.bs.modal', function () {
            const form = $('#formProduct')[0];
            form.reset();
            form.classList.remove("was-validated");
            $('#productName')[0].setCustomValidity("");
            $('#productDescription')[0].setCustomValidity("");
            $('#productPrice')[0].setCustomValidity("");
            $('#productStockQuantity')[0].setCustomValidity("");
        });

        //#endregion

        //#region Inputs Masks and Validations

        $('#productStockQuantity').on('input', function () {
            if (this.value.length > 5) this.value = this.value.slice(0, 5);
        });

        $(document).ready(function () {
            $('#productPrice').mask('#.##0,00', { reverse: true });

            $('#productPrice').on('input', function () {
                let raw = $(this).cleanVal();
                let value = parseInt(raw, 10);
                if (isNaN(value)) value = 0;
                if (value > 100000000) {
                    value = 100000000;
                    $(this).val((value / 100).toLocaleString("pt-BR", { minimumFractionDigits: 2 }));
                }
            });
        });

        //#endregion

        //#region DOM Events

        $('#searchButton').on('click', fetchProducts);

        $(function () {
            fetchProducts();
        });


        $('#addProductButton').on('click', openProductModalInsert);

        //#endregion

    </script>

    <!-- #endregion -->

</body>

</html>