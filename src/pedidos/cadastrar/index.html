<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Pedido</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <div id="navbar"></div>

    <!-- #region Main App -->

    <div id="app" class="container-xxl mt-5">
        <h1 class="text-center mb-4">Cadastro de Pedido</h1>

        <div class="row mb-3">
            <label class="form-label">Cliente:</label>
            <div class="col-12 col-md-10 d-flex input-group">
                <input type="text" id="customerName" data-id="" class="form-control" placeholder="Selecione o cliente"
                    readonly style="box-shadow: none;" />
                <button class="btn btn-primary flex-shrink-0" data-bs-toggle="modal" data-bs-target="#modalCustomer">
                    Selecionar
                </button>
            </div>
        </div>

        <div class="mb-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
                <h4>Itens no Carrinho</h4>
                <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#modalProduct">
                    Adicionar Produtos
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Preço</th>
                            <th>Subtotal</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="cart"></tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="3" class="text-end">Total:</th>
                            <th id="orderTotal">R$ 0,00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="text-end">
            <button class="btn btn-success" id="finishOrder">Finalizar Pedido</button>
        </div>
    </div>

    <!-- #endregion Main App -->

    <!-- #region Modals -->

    <div class="modal fade" id="modalCustomer" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Selecionar Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSearchCustomer" class="input-group mb-3">
                        <input type="text" id="searchCustomer" class="form-control" placeholder="Buscar cliente..." />
                        <button class="btn btn-primary" type="submit">Buscar</button>
                    </form>
                    <div id="clientListContainer">

                        <div id="loadingSpinnerClients" class="text-center my-3" style="display:none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalProduct" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Adicionar Produto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formSearchProduct" class="input-group mb-3">
                        <input type="text" id="searchProduct" class="form-control" placeholder="Buscar produto..." />
                        <button class="btn btn-primary" type="submit">Buscar</button>
                    </form>
                    <div id="productListContainer">


    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-50" id="loadingSpinnerProducts" style="display:none;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- #endregion Modals -->

    <!-- #region Scripts -->

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../../js/components/navbar.js"></script>
    <script src="../../js/services/api.js"></script>

    <script>
        let cart = [];

        //#region Fetch Clients

        function fetchClients() {
            event.preventDefault();
            const searchValue = $("#searchCustomer").val();
            const $container = $("#clientListContainer");
            const $spinner = $('#loadingSpinnerClients');

            $spinner.show();
            $container.find('table').addClass('opacity-50');
            api.get(`/clients/simple?nameOrEmail=${searchValue}`)
                .then(response => {
                    $spinner.hide();
                    $container.html(response.data);

                    $($container).on("click", ".select-customer", function () {
                        let selectedCustomerId = $(this).data("id");
                        let selectedCustomerName = $(this).data("name");

                        $("#customerName").data("data-id", selectedCustomerId);
                        $("#customerName").val(selectedCustomerName);
                        $("#modalCustomer").modal("hide");
                    });

                })
                .catch(error => {
                    console.error("Erro ao abrir modal do cliente:", error);
                    alert("Não foi possível carregar os dados do cliente.");
                });
        }

        //#endregion

        //#region Fetch Products

        function fetchProducts() {
            event.preventDefault();
            const $container = $("#productListContainer");
            const searchValue = $("#searchProduct").val();
            const $spinner = $('#loadingSpinnerProducts');
            
            $container.find('table').addClass('opacity-50');
            $spinner.show();

            api.get(`/products/simple?name=${searchValue}`)
                .then(response => {
                    $spinner.hide();
                    $container.html(response.data);
                })
                .catch(error => {
                    console.error("Erro ao carregar produtos:", error);
                    alert("Não foi possível carregar os produtos.");
                });
        }

        //#endregion

        //#region Cart Management

        $("#finishOrder").on("click", function () {
            let customerId = $("#customerName").data("data-id");

            if (!customerId) {
                alert("Por favor, selecione um cliente.");
                return;
            }
            if (cart.length === 0) {
                alert("O carrinho está vazio. Adicione produtos antes de finalizar o pedido.");
                return;
            }

            let orderData = {
                clientId: customerId,
                items: cart.map(item => ({
                    productId: item.id,
                    quantity: item.qty
                }))
            };

            api.post('/order', orderData)
                .then(response => {
                    alert("Pedido cadastrado com sucesso!");
                    window.location.href = "../";
                })
                .catch(error => {
                    handleApiError(error);
                });
        });

        $("#searchCustomer").on("keyup", function () {
            let filter = $(this).val().toLowerCase();
            $("#customerList li").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(filter) > -1);
            });
        });

        $('#modalCustomer').on('shown.bs.modal', fetchClients);

        $('#formSearchCustomer').on("submit", fetchClients);

        $('#modalProduct').on('shown.bs.modal', fetchProducts);

        $('#formSearchProduct').on("submit", fetchProducts);

        $(document).on("click", ".select-product", function () {
            let name = $(this).data("name");
            let id = $(this).data("id");
            let priceString = $(this).data("price");
            let price = parseFloat(priceString.replace(",", ".")) || 0;

            let existingProduct = cart.find(p => p.id === id);
            if (existingProduct) {
                existingProduct.qty++;
            } else {
                cart.push({ id, name, price, qty: 1 });
            }

            updateCart();
        });

        $(document).on("change", ".qty-input", function () {
            let index = $(this).data("index");
            let newQty = parseInt($(this).val());
            if (newQty > 0) {
                cart[index].qty = newQty;
            } else {
                cart[index].qty = 1;
                $(this).val(1);
            }
            updateCart();
        });

        $(document).on("click", ".remove", function () {
            let index = $(this).data("index");
            cart.splice(index, 1);
            updateCart();
        });

        function updateCart() {
            let tbody = $("#cart");
            tbody.empty();
            let total = 0.00;

            cart.forEach((item, index) => {
                const qty = parseFloat(item.qty) || 0;
                const price = parseFloat(item.price) || 0;

                const subtotal = qty * price;
                total += subtotal;

                tbody.append(`
            <tr>
                <td>${item.name}</td>
                <td>
                    <input type="number" min="1" value="${qty}" 
                        class="form-control form-control-sm qty-input" 
                        data-index="${index}">
                </td>
                <td>R$ ${price.toFixed(2)}</td>
                <td>R$ ${subtotal.toFixed(2)}</td>
                <td>
                    <button class="btn btn-danger btn-sm remove" data-index="${index}">Remover</button>
                </td>
            </tr>
        `);
            });

            $("#orderTotal").text("R$ " + total.toFixed(2));
        }

        //#endregion

    </script>

    <!-- #endregion Scripts -->
</body>

</html>