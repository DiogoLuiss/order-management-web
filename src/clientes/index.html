<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Sistema de Gerenciamento de Pedidos</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">
</head>

<body>

    <div id="navbar"></div>

    <!-- #region Main App -->

    <div id="app" class="container-xxl mt-5">

        <div class="mt-5">
            <h1 class="mb-4">Lista de Clientes</h1>

            <div class="row mb-3">
                <div class="col-md-6">
                    <form id="searchForm" class="input-group">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control"
                                placeholder="Buscar por nome ou email">
                            <button id="searchButton" class="btn btn-primary" type="submit">Buscar</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success btn-add-client" data-bs-toggle="modal" data-bs-target="#modalClient"
                        id="addClientButton">
                        Adicionar Cliente
                    </button>
                </div>
            </div>

            <div class="table-responsive" id="clientesContainer">
                <div id="loadingSpinner" class="text-center my-3" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- #endregion Main App -->

    <!-- #region Modals -->

    <!-- Add/Edit Client Modal -->
    <div class="modal fade" id="modalClient" tabindex="-1" aria-labelledby="modalClientLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalClientLabel">Cadastro de Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formClient" novalidate>
                        <input type="hidden" id="clientId" value="">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="name" placeholder="Digite o nome" required
                                maxlength="255">
                            <div class="invalid-feedback">O nome é obrigatório e deve ter no máximo 255 caracteres.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" inputmode="email" class="form-control" id="email"
                                placeholder="Digite o email" required maxlength="255">
                            <div class="invalid-feedback">O email é obrigatório. Exemplo: abc@example.com e ter no
                                máximo 255 caracteres.</div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="phone" placeholder="(11) 99999-9999" required
                                maxlength="15" minlength="14" inputmode="tel">
                            <div class="invalid-feedback">O telefone é obrigatório.</div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger me-2"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">Confirmar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Client Modal -->
    <div class="modal fade" id="modalDeleteClient" tabindex="-1" aria-labelledby="modalDeleteClientLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalDeleteClientLabel">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteClientMessage"></p>
                    <input type="hidden" id="deleteClientId" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteClient">Deletar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- #endregion Modals -->

    <!-- #region Scripts -->

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/components/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../js/services/api.js"></script>
    <script src="../js/components/toast.js"></script>

    <script>

        //#region Fetch Clients

        function fetchClients() {
            const searchValue = $('#searchInput').val().trim();

            const $container = $('#clientesContainer');
            const spinner = $('#loadingSpinner');

            $container.find('table').addClass('opacity-50');
            spinner.show();

            api.get(`/clients?nameOrEmail=${searchValue}`)
                .then(response => {
                    spinner.hide();
                    $container.html(response.data);

                    $container.find('.btn-update').off('click').on('click', function () {
                        const clientId = $(this).closest('tr').find('td:first').text().trim();
                        openClientModal(clientId);
                    });

                    $container.find('.btn-delete').off('click').on('click', function () {
                        const clientId = $(this).data('id');
                        const nameClient = $(this).data('name');
                        openDeleteModal(clientId, nameClient);
                    });

                })
                .catch(error => {
                    handleApiError(error);
                });
        }

        //#endregion

        //#region Open Add Client Modal

        function openClientModalInsert() {
            const $modal = $('#modalClient');
            $('#formClient')[0].reset();
            $('#modalClientLabel').text("Adicionar Novo Cliente");
            $('#clientId').val("");
            $modal.modal('show');
        }

        //#endregion

        //#region DOM Events

        $('#searchButton').on('click', function (e) { e.preventDefault(); fetchClients(); });
        $(document).ready(function () {
            fetchClients();
            $('#addClientButton').on('click', openClientModalInsert);
        });

        //#endregion

        //#region Input Validations

        $("#email").on("blur", function () {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
            this.setCustomValidity(regex.test(this.value) ? "" : "invalid");
        });

        $('#phone').on('input', function () {
            let digits = $(this).val().replace(/\D/g, '');

            if (digits.length === 0) {
                $(this).val('');
                this.setCustomValidity('invalid');
                return;
            }

            if (digits.length > 11) digits = digits.slice(0, 11);

            if (digits.length <= 2) $(this).val(`(${digits}`);
            else if (digits.length <= 6) $(this).val(`(${digits.slice(0, 2)}) ${digits.slice(2)}`);
            else if (digits.length <= 10) $(this).val(`(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`);
            else $(this).val(`(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`);

            const regex = /^\(\d{2}\)\s\d{4,5}-\d{4}$/;
            this.setCustomValidity(regex.test($(this).val()) ? "" : "invalid");
        });

        //#endregion

        //#region Submit Client Form

        $("#formClient").on("submit", function (e) {
            e.preventDefault();
            const form = this;

            if (!form.checkValidity()) {
                e.stopPropagation();
                $(form).addClass("was-validated");
                return;
            }

            const client = {
                name: $("#name").val().trim(),
                email: $("#email").val().trim().toLowerCase(),
                phone: $("#phone").val().replace(/\D/g, "")
            };

            const clientId = $("#clientId").val();

            if (clientId) {
                api.put(`/client/${clientId}`, client)
                    .then(response => {
                        showToast(response.data.message || "Cliente atualizado com sucesso!", "success");
                        $('#modalClient').modal('hide');
                        $('#searchButton').click();
                    })
                    .catch(handleApiError);
            } else {
                api.post("/client", client)
                    .then(response => {
                        showToast(response.data.message || "Cliente cadastrado com sucesso!", "success");
                        $('#modalClient').modal('hide');
                        $('#searchButton').click();
                    })
                    .catch(handleApiError);
            }
        });

        //#endregion

        //#region Reset Modal on Close

        $('#modalClient').on('hidden.bs.modal', function () {
            const form = $('#formClient')[0];
            form.reset();
            $(form).removeClass("was-validated");
            $("#name, #email, #phone").each(function () { this.setCustomValidity(""); });
        });

        //#endregion

        //#region Open Edit Client Modal

        function openClientModal(clientId) {
            api.get(`/client/${clientId}`)
                .then(response => {
                    const client = response.data;
                    $('#name').val(client.name);
                    $('#email').val(client.email);
                    $('#phone').val(client.phone);
                    $('#modalClientLabel').text("Editar Cliente");
                    $('#clientId').val(client.id);
                    $('#modalClient').modal('show');
                })
                .catch(handleApiError);
        }

        //#endregion

        //#region Delete Client Modal

        function openDeleteModal(clientId, nameClient) {
            $('#deleteClientId').val(clientId);
            $('#deleteClientMessage').text(`Tem certeza que deseja deletar o cliente ${nameClient}?`);
            $('#modalDeleteClient').modal('show');
        }

        $('#confirmDeleteClient').on('click', function () {
            const clientId = $('#deleteClientId').val();
            api.delete(`/client/${clientId}`)
                .then((data) => {
                    showToast(data.message || "Cliente deletado com sucesso!", "success");
                    $('#modalDeleteClient').modal('hide');
                    $('#searchButton').click();
                })
                .catch(handleApiError);
        });

        //#endregion
    </script>

    <!-- #endregion -->

</body>

</html>