<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Sistema de Gerenciamento de Pedidos</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div id="navbar"></div>
    <div id="app" class="container-xxl mt-5">

        <div class="mt-5">
            <h1 class="mb-4">Lista de Clientes</h1>

            <div class="row mb-3">
                <div class="col-md-6">
                    <form id="searchForm" class="input-group">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control"
                                placeholder="Buscar por nome ou email">
                            <button id="searchButton" class="btn btn-primary" type="submit">Buscar</button>
                        </div>
                    </form>
                </div>

                <div class="col-md-6 text-end ">
                    <button class="btn btn-success btn-add-client" data-bs-toggle="modal" data-bs-target="#modalClient"
                        id="addClientButton">
                        Adicionar Cliente
                    </button>
                </div>
            </div>

            <div class="table-responsive" id="clientesContainer">
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalClient" tabindex="-1" aria-labelledby="modalClientLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalClientLabel">Cadastro de Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formClient" novalidate>
                        <input type="hidden" id="clientId" value="">

                        <div class="mb-3">
                            <label for="name" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="name" placeholder="Digite o nome" required maxlength="255">
                            <div class="invalid-feedback">O nome é obrigatório e deve ter no máximo 255 caracteres.</div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label re">Email</label>
                            <input type="email" inputmode="email" class="form-control" id="email" placeholder="Digite o email" required maxlength="255">
                            <div class="invalid-feedback">O email é obrigatório. Exemplo: abc@example.com e ter no maximo 255 caracteres.</div>

                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="phone" 
                                placeholder="(11) 99999-9999" required maxlength="15" minlength="14" inputmode="tel">
                            <div class="invalid-feedback">O telefone é obrigatório.</div>

                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger me-2"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">Confirmar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDeleteClient" tabindex="-1" aria-labelledby="modalDeleteClientLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalDeleteClientLabel">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteClientMessage"></p>
                    <input type="hidden" id="deleteClientId" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteClient">Deletar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/components/navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../js/services/api.js"></script>

    <script>
        //#region Fetch Clients
        function fetchClients() {
            event.preventDefault();
            const searchValue = document.getElementById('searchInput').value;

            api.get(`/clients?nameOrEmail=${searchValue}`)
                .then(response => {
                    const container = document.getElementById('clientesContainer');
                    container.innerHTML = response.data;

                    container.querySelectorAll('.btn-update').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const clientId = this.closest('tr').querySelector('td').textContent.trim();
                            openClientModal(clientId);
                        });
                    });

                    container.querySelectorAll('.btn-delete').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const clientId = this.dataset.id;
                            const nameClient = this.dataset.name;
                            openDeleteModal(clientId, nameClient);
                        });
                    });

                })
                .catch(error => {
                    handleApiError(error);
                });
        }
        //#endregion

        //#region Open Add Client Modal
        function openClientModalInsert() {
            const modalElement = document.getElementById('modalClient');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);

            document.getElementById('formClient').reset();
            document.getElementById('modalClientLabel').textContent = "Adicionar Novo Cliente";
            document.getElementById('clientId').value = "";
            modal.show();
        }
        //#endregion

        //#region DOM Events
        document.getElementById('searchButton').addEventListener('click', fetchClients);
        document.addEventListener('DOMContentLoaded', fetchClients);
        document.getElementById('addClientButton').addEventListener('click', openClientModalInsert);
        //#endregion

        const emailInput = document.getElementById("email");

        emailInput.addEventListener("blur", function () {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
            if (!regex.test(this.value)) {
                this.setCustomValidity("invalid");
            } else {
                this.setCustomValidity(""); 
            }
        });



        document.addEventListener('DOMContentLoaded', () => {
            const phoneInput = document.getElementById('phone');

            phoneInput.addEventListener('input', function () {
                let digits = this.value.replace(/\D/g, '');

                if (digits.length === 0) {
                this.value = '';
                this.setCustomValidity('invalid');
                return;
                }

                if (digits.length > 11) digits = digits.slice(0, 11);

                if (digits.length <= 2) {
                this.value = `(${digits}`;
                } else if (digits.length <= 6) {
                this.value = `(${digits.slice(0, 2)}) ${digits.slice(2)}`;
                } else if (digits.length <= 10) {
                this.value = `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
                } else {
                this.value = `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
                }

                const regex = /^\(\d{2}\)\s\d{4,5}-\d{4}$/;
                if (!regex.test(this.value)) {
                this.setCustomValidity('invalid');
                } else {
                this.setCustomValidity('');
                }
            });
        });



        //#region Submit Client Form
        $("#formClient").on("submit", function (e) {
            e.preventDefault();

             const form = this;

            if (!form.checkValidity()) {
                e.stopPropagation();
                $(form).addClass("was-validated"); 
                return; 
            }
           
            const client = {
                name: $("#name").val().trim(),
                email: $("#email").val().trim().toLowerCase(), 
                phone: $("#phone").val().replace(/\D/g, "") // remove non-digit characters
            };


            const clientId = $("#clientId").val();  

            if (clientId) {
                // Update client
                api.put(`/client/${clientId}`, client)
                    .then(response => {
                        alert(response.data.message || "Cliente atualizado com sucesso!");
                        bootstrap.Modal.getInstance(document.getElementById('modalClient')).hide();
                        document.getElementById('searchButton').click();
                    })
                    .catch(error => {
                        handleApiError(error);
                    });
            } else {
                // Add new client
                api.post("/client", client)
                    .then(response => {
                        alert(response.data.message || "Cliente cadastrado com sucesso!");
                        bootstrap.Modal.getInstance(document.getElementById('modalClient')).hide();
                        document.getElementById('searchButton').click();
                    })
                    .catch(error => {
                        handleApiError(error);
                    });
            }
        });
        //#endregion

        


         $('#modalClient').on('hidden.bs.modal', function () {
            const form = $("#formClient")[0];

            form.reset();
            form.classList.remove("was-validated");

            $("#name")[0].setCustomValidity("");
            $("#email")[0].setCustomValidity("");
            $("#phone")[0].setCustomValidity("");
            
        });

        //#region Open Edit Client Modal
        function openClientModal(clientId) {
            api.get(`/client/${clientId}`)
                .then(response => {
                    const client = response.data;
                    document.getElementById('name').value = client.name;
                    document.getElementById('email').value = client.email;
                    document.getElementById('phone').value = client.phone;
                    document.getElementById('modalClientLabel').textContent = "Editar Cliente";
                    document.getElementById('clientId').value = client.id;

                    const modalElement = document.getElementById('modalClient');
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                })
                .catch(error => {
                    handleApiError(error);
                });
        }
        //#endregion

        //#region Delete Client Modal
        function openDeleteModal(clientId, nameClient) {
            document.getElementById('deleteClientId').value = clientId;
            document.getElementById('deleteClientMessage').textContent = `Tem certeza que deseja deletar o cliente ${nameClient}?`;
            const modal = new bootstrap.Modal(document.getElementById('modalDeleteClient'));
            modal.show();
        }

        document.getElementById('confirmDeleteClient').addEventListener('click', function () {
            const clientId = document.getElementById('deleteClientId').value;

            api.delete(`/client/${clientId}`)
                .then(() => {
                    alert("Cliente deletado com sucesso!");
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalDeleteClient'));
                    modal.hide();
                    document.getElementById('searchButton').click(); // Refresh list
                })
                .catch(err => {
                    handleApiError(err);
                });
        });
        //#endregion
    </script>

</body>

</html>